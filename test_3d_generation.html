<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 3D Generation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; font-family: Arial; }
        #canvas { width: 100vw; height: 70vh; }
        #controls { padding: 20px; background: #f0f0f0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #status { margin: 10px 0; padding: 10px; background: #fff; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div id="controls">
        <h2>Test Claude 4.5 3D Generation</h2>
        <button onclick="generateSimpleRoom()">Generate Simple Room</button>
        <button onclick="generateChair()">Generate Chair</button>
        <div id="status">Ready</div>
    </div>
    <div id="canvas"></div>

    <script>
        let scene, camera, renderer, controls;

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Grid
            const gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        async function generateSimpleRoom() {
            document.getElementById('status').innerHTML = 'Generating room...';
            
            try {
                const response = await fetch('http://localhost:8000/api/generate-complete-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_data: 'https://example.com/room.jpg',
                        description: 'Simple bedroom with bed and nightstands',
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                console.log('Response:', data);
                
                // The code should already be clean from backend
                let code = data.code;
                console.log('Code received, length:', code.length);
                console.log('First 200 chars:', code.substring(0, 200));
                
                // Execute the code - it should already have the return statement
                const func = new Function('THREE', code + '\nif (typeof createCompleteRoom === "function") { return createCompleteRoom(); } else { throw new Error("Function not found"); }');
                const generatedScene = func(THREE);
                
                // Clear existing objects (keep lights and grid)
                scene.children = scene.children.filter(child => 
                    child instanceof THREE.Light || child instanceof THREE.GridHelper
                );
                
                // Add generated objects
                generatedScene.children.forEach(child => {
                    if (!(child instanceof THREE.Light)) {
                        scene.add(child.clone());
                    }
                });
                
                document.getElementById('status').innerHTML = `✅ Room generated! Objects: ${generatedScene.children.length}`;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        async function generateChair() {
            document.getElementById('status').innerHTML = 'Generating chair...';
            
            try {
                const response = await fetch('http://localhost:8000/api/generate-3d', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        furniture_type: 'chair',
                        style: 'modern',
                        colors: ['brown', 'black'],
                        materials: ['wood', 'metal']
                    })
                });

                const data = await response.json();
                console.log('Response:', data);
                
                // Execute the code
                const func = new Function('THREE', data.code + '\nreturn createFurniture();');
                const chair = func(THREE);
                
                // Clear existing objects (keep lights and grid)
                scene.children = scene.children.filter(child => 
                    child instanceof THREE.Light || child instanceof THREE.GridHelper
                );
                
                // Add chair
                scene.add(chair);
                
                document.getElementById('status').innerHTML = `✅ Chair generated! Source: ${data.source}`;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>