<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple 3D Test - Debug Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial; background: #f0f0f0; }
        #canvas { width: 100%; height: 70vh; border: 2px solid #333; }
        #controls { padding: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:hover { background: #45a049; }
        #status { margin: 10px 0; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div id="controls">
        <h2>Simple 3D Test - Debugging</h2>
        <button onclick="testBasicCube()">1. Test Basic Cube (Local)</button>
        <button onclick="testFallbackChair()">2. Test Fallback Chair</button>
        <button onclick="testAPIGeneration()">3. Test API Generation</button>
        <button onclick="clearScene()">Clear Scene</button>
        <div id="status">Ready to test...</div>
    </div>
    <div id="canvas"></div>

    <script>
        let scene, camera, renderer, animationId;

        // Initialize Three.js
        function init() {
            console.log('Initializing Three.js...');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Camera
            const container = document.getElementById('canvas');
            camera = new THREE.PerspectiveCamera(
                75, 
                container.clientWidth / container.clientHeight, 
                0.1, 
                1000
            );
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Grid
            const gridHelper = new THREE.GridHelper(10, 10);
            scene.add(gridHelper);

            // Axes helper (to see orientation)
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // Start animation
            animate();
            
            updateStatus('Three.js initialized successfully!', 'success');
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Rotate camera around center
            const time = Date.now() * 0.0005;
            camera.position.x = Math.cos(time) * 8;
            camera.position.z = Math.sin(time) * 8;
            camera.lookAt(0, 0, 0);
            
            renderer.render(scene, camera);
        }

        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            console.log(message);
        }

        function clearScene() {
            // Remove all meshes but keep lights and helpers
            const toRemove = [];
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh) {
                    toRemove.push(child);
                }
            });
            toRemove.forEach(obj => scene.remove(obj));
            updateStatus('Scene cleared', 'success');
        }

        // Test 1: Basic Cube (no API needed)
        function testBasicCube() {
            clearScene();
            updateStatus('Creating basic cube...', '');
            
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x00ff00,
                shininess: 100 
            });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.y = 1;
            cube.castShadow = true;
            cube.receiveShadow = true;
            scene.add(cube);
            
            updateStatus('✅ Basic cube created! You should see a green cube.', 'success');
        }

        // Test 2: Fallback Chair (hardcoded)
        function testFallbackChair() {
            clearScene();
            updateStatus('Creating fallback chair...', '');
            
            try {
                const chairCode = `
                function createFurniture() {
                    const group = new THREE.Group();
                    
                    // Seat
                    const seatGeometry = new THREE.BoxGeometry(0.45, 0.05, 0.45);
                    const seatMaterial = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
                    const seat = new THREE.Mesh(seatGeometry, seatMaterial);
                    seat.position.y = 0.45;
                    group.add(seat);
                    
                    // Backrest
                    const backGeometry = new THREE.BoxGeometry(0.45, 0.5, 0.05);
                    const backrest = new THREE.Mesh(backGeometry, seatMaterial);
                    backrest.position.set(0, 0.7, -0.2);
                    group.add(backrest);
                    
                    // Legs
                    const legGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.45);
                    const legMaterial = new THREE.MeshPhongMaterial({ color: 0x654321 });
                    
                    const positions = [
                        [-0.2, 0.225, -0.2],
                        [0.2, 0.225, -0.2],
                        [-0.2, 0.225, 0.2],
                        [0.2, 0.225, 0.2]
                    ];
                    
                    positions.forEach(pos => {
                        const leg = new THREE.Mesh(legGeometry, legMaterial);
                        leg.position.set(pos[0], pos[1], pos[2]);
                        group.add(leg);
                    });
                    
                    return group;
                }`;
                
                const func = new Function('THREE', chairCode + '\nreturn createFurniture();');
                const chair = func(THREE);
                scene.add(chair);
                
                updateStatus('✅ Fallback chair created! You should see a brown chair.', 'success');
            } catch (error) {
                updateStatus(`❌ Error creating chair: ${error.message}`, 'error');
            }
        }

        // Test 3: API Generation
        async function testAPIGeneration() {
            clearScene();
            updateStatus('Calling API to generate furniture...', '');
            
            try {
                const response = await fetch('http://localhost:8000/api/generate-3d', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        furniture_type: 'table',
                        style: 'modern',
                        colors: ['brown', 'black'],
                        materials: ['wood', 'metal'],
                        use_cached: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.code) {
                    throw new Error('No code in response');
                }
                
                // Try to execute the generated code
                const func = new Function('THREE', data.code + '\nreturn createFurniture();');
                const furniture = func(THREE);
                scene.add(furniture);
                
                updateStatus(`✅ API furniture created! Source: ${data.source}`, 'success');
            } catch (error) {
                console.error('API Error:', error);
                updateStatus(`❌ API Error: ${error.message}`, 'error');
                
                // Try fallback
                updateStatus('Trying fallback...', '');
                testFallbackChair();
            }
        }

        // Initialize on load
        window.onload = () => {
            init();
            // Automatically test basic cube to verify Three.js is working
            setTimeout(() => testBasicCube(), 1000);
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('canvas');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    </script>
</body>
</html>