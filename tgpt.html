<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draggable 3D Room from Floor Plan</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #renderCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>Upload Floor Plan</h2>
        <input type="file" id="fileInput" accept="image/*">
        <div id="status">Ready</div>
    </div>
    <canvas id="renderCanvas"></canvas>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script>
        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        let scene;
        let roomRoot;

        function createScene() {
            scene = new BABYLON.Scene(engine);

            // Camera with top-down view
            const camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 2, Math.PI / 3, 10, new BABYLON.Vector3(0, 1, 0), scene);
            camera.attachControl(canvas, true);
            camera.wheelPrecision = 100;
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 100;

            // Lights
            const light = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);

            // Room root
            roomRoot = new BABYLON.TransformNode("roomRoot", scene);

            // Enable dragging the room
            const pointerDragBehavior = new BABYLON.PointerDragBehavior({
                dragAxis: new BABYLON.Vector3(1, 0, 1)
            });
            pointerDragBehavior.useObjectOrientationForDragging = false;
            roomRoot.addBehavior(pointerDragBehavior);

            return scene;
        }

        // Function to process floor plan image
        async function processFloorPlan(file) {
            const status = document.getElementById('status');
            status.innerText = 'Processing image...';

            const img = new Image();
            img.src = URL.createObjectURL(file);
            await img.decode();

            const canvas2d = document.createElement('canvas');
            canvas2d.width = img.width;
            canvas2d.height = img.height;
            const ctx = canvas2d.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const data = ctx.getImageData(0, 0, img.width, img.height).data;

            console.log('Image loaded:', img.width, 'x', img.height);

            // Simple wall detection: assume black lines are walls
            const scale = 0.05;
            const roomWidth = img.width * scale;
            const roomDepth = img.height * scale;
            const roomHeight = 2.7;

            console.log('Room dimensions (m):', roomWidth, roomDepth);

            // Create 4 walls (placeholder, openings for doors can be added later)
            const wallMat = new BABYLON.StandardMaterial("wallMat", scene);
            wallMat.diffuseColor = new BABYLON.Color3(0.9, 0.9, 0.9);

            const walls = [];
            // Wall 1 - front
            const w1 = BABYLON.MeshBuilder.CreateBox("wall1", {
                width: roomWidth,
                height: roomHeight,
                depth: 0.1
            }, scene);
            w1.position = new BABYLON.Vector3(roomWidth / 2, roomHeight / 2, 0);
            w1.material = wallMat;
            w1.parent = roomRoot;
            walls.push(w1);

            // Wall 2 - back
            const w2 = BABYLON.MeshBuilder.CreateBox("wall2", {
                width: roomWidth,
                height: roomHeight,
                depth: 0.1
            }, scene);
            w2.position = new BABYLON.Vector3(roomWidth / 2, roomHeight / 2, roomDepth);
            w2.material = wallMat;
            w2.parent = roomRoot;
            walls.push(w2);

            // Wall 3 - left
            const w3 = BABYLON.MeshBuilder.CreateBox("wall3", {
                width: 0.1,
                height: roomHeight,
                depth: roomDepth
            }, scene);
            w3.position = new BABYLON.Vector3(0, roomHeight / 2, roomDepth / 2);
            w3.material = wallMat;
            w3.parent = roomRoot;
            walls.push(w3);

            // Wall 4 - right
            const w4 = BABYLON.MeshBuilder.CreateBox("wall4", {
                width: 0.1,
                height: roomHeight,
                depth: roomDepth
            }, scene);
            w4.position = new BABYLON.Vector3(roomWidth, roomHeight / 2, roomDepth / 2);
            w4.material = wallMat;
            w4.parent = roomRoot;
            walls.push(w4);

            console.log('Walls created');

            // Semi-transparent ceiling
            const ceiling = BABYLON.MeshBuilder.CreateBox("ceiling", {
                width: roomWidth,
                depth: roomDepth,
                height: 0.05
            }, scene);
            ceiling.position = new BABYLON.Vector3(roomWidth / 2, roomHeight, roomDepth / 2);
            const ceilMat = new BABYLON.StandardMaterial("ceilMat", scene);
            ceilMat.alpha = 0.3;
            ceilMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
            ceiling.material = ceilMat;
            ceiling.parent = roomRoot;

            // Floor
            const floor = BABYLON.MeshBuilder.CreateBox("floor", {
                width: roomWidth,
                depth: roomDepth,
                height: 0.1
            }, scene);
            floor.position = new BABYLON.Vector3(roomWidth / 2, 0, roomDepth / 2);
            const floorMat = new BABYLON.StandardMaterial("floorMat", scene);
            floorMat.diffuseColor = new BABYLON.Color3(0.5, 0.4, 0.3);
            floor.material = floorMat;
            floor.parent = roomRoot;

            // Add Bed in bedroom
            const bed = BABYLON.MeshBuilder.CreateBox("bed", {
                width: 1.8,
                depth: 2,
                height: 0.5
            }, scene);
            bed.position = new BABYLON.Vector3(roomWidth * 0.7, 0.25, roomDepth * 0.7);
            const bedMat = new BABYLON.StandardMaterial("bedMat", scene);
            bedMat.diffuseColor = new BABYLON.Color3(0.2, 0.6, 0.9);
            bed.material = bedMat;
            bed.parent = roomRoot;

            // Add countertop in kitchen
            const counter = BABYLON.MeshBuilder.CreateBox("counter", {
                width: 2,
                depth: 0.6,
                height: 0.9
            }, scene);
            counter.position = new BABYLON.Vector3(roomWidth * 0.3, 0.45, roomDepth * 0.3);
            const counterMat = new BABYLON.StandardMaterial("counterMat", scene);
            counterMat.diffuseColor = new BABYLON.Color3(0.8, 0.8, 0.8);
            counter.material = counterMat;
            counter.parent = roomRoot;

            console.log('Furniture added');
            status.innerText = 'Room generated! Drag the room with mouse.';
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            try {
                await processFloorPlan(file);
            } catch (err) {
                console.error('Error processing floor plan:', err);
            }
        });

        scene = createScene();
        engine.runRenderLoop(() => {
            scene.render();
        });
        window.addEventListener('resize', () => {
            engine.resize();
        });
    </script>
</body>

</html>
